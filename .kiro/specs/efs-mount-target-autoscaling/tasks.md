# 実装計画

- [x] 1. プロジェクト構造とコア設定の準備
  - Pythonプロジェクトの基本構造を作成（Lambda関数用とFargateアプリケーション用）
  - 依存関係管理ファイル（requirements.txt）を作成
  - テストフレームワーク（pytest、Hypothesis）をセットアップ
  - _要件: 全般_

- [x] 2. Lambda関数: ファイル数カウント機能の実装
  - [x] 2.1 ファイル数カウント関数を実装
    - EFSマウントポイントからターゲットディレクトリを読み取る関数を作成
    - ディレクトリ内のファイル数をカウントするロジックを実装
    - 環境変数から設定を読み取る機能を実装
    - _要件: 1.2, 7.1, 7.2_

  - [x] 2.2 プロパティテスト: ファイル数カウントの正確性
    - **Property 1: ファイル数カウントの正確性**
    - **検証: 要件 1.2**

- [x] 3. Lambda関数: 閾値判定とMount Target作成ロジックの実装
  - [x] 3.1 閾値判定ロジックを実装
    - ファイル数と閾値を比較する関数を作成
    - 環境変数から閾値を読み取る機能を実装
    - _要件: 1.3, 7.1_

  - [x] 3.2 プロパティテスト: 閾値判定の一貫性
    - **Property 2: 閾値判定の一貫性**
    - **検証: 要件 1.3**

  - [x] 3.3 既存Mount Target取得機能を実装
    - AWS EFS APIを使用して既存のMount Targetリストを取得する関数を作成
    - _要件: 1.4_

  - [x] 3.4 利用可能なサブネット特定機能を実装
    - VPC内の全サブネットを取得し、既にMount Targetが存在しないサブネットを特定する関数を作成
    - 環境変数からVPC IDを読み取る機能を実装
    - _要件: 1.4, 7.3_

  - [x] 3.5 Mount Target作成機能を実装
    - AWS EFS CreateMountTarget APIを呼び出す関数を作成
    - Mount Targetの作成完了を待機するロジックを実装（ポーリング）
    - エラーハンドリングを実装（作成失敗時の処理）
    - _要件: 1.4, 6.2, 6.3_

  - [ ]* 3.6 プロパティテスト: Mount Target作成の冪等性
    - **Property 3: Mount Target作成の冪等性**
    - **検証: 要件 1.4**

- [x] 4. Lambda関数: SSM Parameter Store連携機能の実装
  - [x] 4.1 Mount TargetリストのJSON変換機能を実装
    - Mount Target情報をJSON形式に変換する関数を作成
    - データモデルに従った構造を実装
    - _要件: 1.5_

  - [x] 4.2 SSM Parameter Store更新機能を実装
    - AWS SSM PutParameter APIを呼び出す関数を作成
    - 環境変数からSSMパラメータ名を読み取る機能を実装
    - エラーハンドリングを実装（更新失敗時の処理）
    - _要件: 1.5, 6.3, 7.5_

  - [x] 4.3 プロパティテスト: SSM Parameter Storeの更新整合性
    - **Property 4: SSM Parameter Storeの更新整合性**
    - **検証: 要件 1.5, 2.1**

- [x] 5. Lambda関数: ECS Service更新機能の実装
  - [x] 5.1 ECS Service強制デプロイメント機能を実装
    - AWS ECS UpdateService APIを呼び出す関数を作成（forceNewDeployment=True）
    - 環境変数からECSクラスター名とサービス名を読み取る機能を実装
    - エラーハンドリングを実装（更新失敗時の処理）
    - _要件: 2.3_

- [x] 6. Lambda関数: メインハンドラーとロギングの実装
  - [x] 6.1 Lambda関数のメインハンドラーを実装
    - 全ての機能を統合するlambda_handler関数を作成
    - 処理フローを実装（ファイル数カウント → 閾値判定 → Mount Target作成 → SSM更新 → ECS更新）
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 2.3_

  - [x] 6.2 包括的なロギング機能を実装
    - 実行開始・終了のログを記録
    - ファイル数カウント結果のログを記録
    - Mount Target作成処理のログを記録（開始、進行状況、完了）
    - エラー発生時の詳細ログを記録
    - _要件: 5.1, 5.2, 5.3, 5.4_

  - [x] 6.3 エラーハンドリングの統合
    - 各処理でのエラーを適切にキャッチして処理
    - エラー時の状態保持を実装
    - _要件: 6.1, 6.2, 6.3_

  - [ ]* 6.4 プロパティテスト: エラー時の状態保持
    - **Property 7: エラー時の状態保持**
    - **検証: 要件 6.1, 6.2, 6.3**

- [x] 7. チェックポイント - Lambda関数のテスト確認
  - 全てのテストが通過することを確認し、問題があればユーザーに質問する

- [x] 8. Fargateアプリケーション: SSM Parameter Store取得機能の実装
  - [x] 8.1 SSM Parameter Store取得機能を実装
    - AWS SSM GetParameter APIを呼び出す関数を作成
    - 環境変数からSSMパラメータ名を読み取る機能を実装
    - JSONデータをパースしてMount Targetリストを取得
    - エラーハンドリングを実装（取得失敗時のデフォルト設定使用）
    - _要件: 2.1, 6.4, 7.5_

- [x] 9. Fargateアプリケーション: Mount Target マウント機能の実装
  - [x] 9.1 NFSマウント機能を実装
    - 各Mount TargetをNFSマウントする関数を作成
    - マウントポイントを動的に作成（/mnt/efs-0, /mnt/efs-1, ...）
    - マウント成功・失敗のログを記録
    - エラーハンドリングを実装（マウント失敗時のスキップ処理）
    - _要件: 2.2, 5.5, 6.5_

  - [ ]* 9.2 プロパティテスト: Mount失敗時のフォールバック
    - **Property 8: Mount失敗時のフォールバック**
    - **検証: 要件 6.5**

- [x] 10. Fargateアプリケーション: ハッシュベースルーティングの実装
  - [x] 10.1 ファイルパスハッシュ計算機能を実装
    - ファイルパスからハッシュ値を計算する関数を作成
    - ハッシュ値をMount Target数でモジュロ演算する関数を作成
    - _要件: 3.1, 3.2_

  - [ ]* 10.2 プロパティテスト: ハッシュベースルーティングの一貫性
    - **Property 5: ハッシュベースルーティングの一貫性**
    - **検証: 要件 3.1, 3.2, 3.4**

  - [x] 10.3 ファイルパス解決機能を実装
    - 元のファイルパスと選択されたMount Targetインデックスから完全なファイルパスを構築する関数を作成
    - _要件: 3.3_

  - [ ]* 10.4 プロパティテスト: ハッシュベースルーティングの分散性
    - **Property 6: ハッシュベースルーティングの分散性**
    - **検証: 要件 3.3**

- [x] 11. Fargateアプリケーション: 初期化とメイン処理の実装
  - [x] 11.1 アプリケーション初期化処理を実装
    - SSM Parameter Store取得、Mount Targetマウントを統合する初期化関数を作成
    - 初期化失敗時のエラーハンドリングを実装
    - _要件: 2.1, 2.2_

  - [x] 11.2 ファイルアクセスAPI/関数を実装
    - ハッシュベースルーティングを使用してファイルにアクセスする関数を作成
    - 読み取り・書き込み操作を実装
    - _要件: 3.1, 3.2, 3.3, 3.4_

- [x] 12. チェックポイント - Fargateアプリケーションのテスト確認
  - 全てのテストが通過することを確認し、問題があればユーザーに質問する

- [x] 13. インフラストラクチャコード（IaC）の作成
  - [x] 13.1 Terraformプロジェクト構造を作成
    - terraform/ディレクトリを作成
    - main.tf、variables.tf、outputs.tfファイルを作成
    - プロバイダー設定（AWS）を定義
    - _要件: 全般_

  - [x] 13.2 VPCとネットワークリソースを定義
    - VPC、サブネット（複数AZ）のリソースを定義
    - セキュリティグループ（Lambda、EFS、Fargate用）を定義
    - _要件: 4.5_

  - [x] 13.3 EFSファイルシステムとMount Targetを定義
    - EFSファイルシステムリソースを定義
    - 初期Mount Target（2つのAZ）を定義
    - EFS用セキュリティグループルールを定義
    - _要件: 全般_

  - [x] 13.4 Lambda関数リソースを定義
    - Lambda関数リソースを定義（デプロイメントパッケージ参照）
    - IAM実行ロールとポリシーを定義（EFS、SSM、ECS、EC2権限）
    - 環境変数を定義（TARGET_DIRECTORY、FILE_COUNT_THRESHOLD等）
    - VPC設定（サブネット、セキュリティグループ）を定義
    - EFSファイルシステムマウント設定を定義
    - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 7.1, 7.2, 7.3_

  - [x] 13.5 EventBridge Ruleを定義
    - EventBridge Ruleリソースを定義
    - スケジュール式を設定（rate(5 minutes)）
    - Lambda関数をターゲットとして設定
    - Lambda関数の実行権限を付与
    - _要件: 1.1, 7.4_

  - [x] 13.6 SSM Parameter Storeを定義
    - SSM Parameterリソースを定義
    - 初期値（空のMount Targetリストまたは初期Mount Target）を設定
    - _要件: 2.1_

  - [x] 13.7 ECS/Fargateリソースを定義
    - ECSクラスターリソースを定義
    - ECRリポジトリを定義（Fargateコンテナイメージ用）
    - IAMタスク実行ロールとタスクロールを定義（SSM、EFS権限）
    - ECSタスク定義を作成（コンテナ定義、環境変数、EFSボリューム設定）
    - ECS Serviceリソースを定義（VPC設定、セキュリティグループ）
    - _要件: 2.1, 2.2, 2.3, 2.4_

- [x] 14. デプロイメント自動化の作成
  - [x] 14.1 Lambda関数デプロイメントスクリプトを作成
    - scripts/deploy_lambda.shを作成
    - Lambda関数コードをZIPパッケージ化するロジックを実装
    - 依存関係を含めるロジックを実装
    - AWS CLIまたはTerraformを使用してデプロイ
    - _要件: 全般_

  - [x] 14.2 Fargateコンテナイメージビルドスクリプトを作成
    - Dockerfileを作成（fargate/Dockerfile）
    - scripts/build_and_push_fargate.shを作成
    - コンテナイメージをビルドするロジックを実装
    - ECRにプッシュするロジックを実装
    - _要件: 全般_

  - [x] 14.3 統合デプロイメントスクリプトを作成
    - scripts/deploy_all.shを作成
    - Terraformによるインフラデプロイを実行
    - Lambda関数デプロイを実行
    - Fargateイメージビルド・プッシュを実行
    - ECS Serviceを更新
    - _要件: 全般_

- [x] 15. ドキュメント拡充
  - [x] 15.1 README.mdを拡充
    - アーキテクチャ図を追加
    - 詳細なセットアップ手順を追加
    - デプロイ手順を追加
    - 環境変数とパラメータの説明を追加
    - トラブルシューティングセクションを追加
    - _要件: 全般_

  - [x] 15.2 デプロイメントガイドを作成
    - docs/DEPLOYMENT.mdを作成
    - 前提条件（AWS CLI、Terraform、Docker等）を記述
    - ステップバイステップのデプロイ手順を記述
    - 設定のカスタマイズ方法を記述
    - _要件: 全般_

- [x] 16. Terraform ECS設定の修正
  - [x] 16.1 ECS deployment_configuration構文エラーを修正
    - terraform/ecs.tfのdeployment_configurationブロックを修正
    - deployment_maximum_percentとdeployment_minimum_healthy_percentに変更
    - _要件: 2.4_

- [x] 17. 最終チェックポイント - 全体統合確認
  - 全てのテストが通過することを確認（70個のテスト全て成功）
  - Terraform設定が正しく動作することを確認（診断エラーなし）
  - デプロイメントスクリプトが正常に動作することを確認

- [x] 18. アーキテクチャ説明資料の作成
  - [x] 18.1 docs/ARCHITECTURE.mdを作成
    - システム概要と課題・ソリューションの説明
    - 全体アーキテクチャ図とネットワークアーキテクチャ図
    - 各コンポーネントの詳細説明
    - データフローの図解
    - スケーリングメカニズムの詳細
    - 負荷分散戦略とハッシュベースルーティングの説明
    - セキュリティアーキテクチャ（IAM、暗号化、監査）
    - 可用性と耐障害性の設計
    - パフォーマンスメトリクスと改善効果
    - _要件: 全般_
